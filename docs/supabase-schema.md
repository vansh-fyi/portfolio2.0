# Supabase Database Schema

This document outlines the database schema used for the RAG (Retrieval-Augmented Generation) system in the portfolio application.

## Extensions

The `vector` extension is required for storing and querying embeddings.

```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

## Tables

### `documents`

Stores text chunks and their corresponding vector embeddings.

| Column       | Type                     | Description                                                                 |
| :----------- | :----------------------- | :-------------------------------------------------------------------------- |
| `id`         | `uuid`                   | Primary Key (auto-generated via `gen_random_uuid()`)                        |
| `content`    | `text`                   | The actual text content of the chunk                                        |
| `embedding`  | `vector(384)`            | 384-dimensional embedding vector (generated by `all-MiniLM-L6-v2`)          |
| `metadata`   | `jsonb`                  | Metadata about the chunk (source file, project ID, etc.)                    |
| `created_at` | `timestamp with time zone` | Timestamp of creation (defaults to `now()`)                                 |

**SQL Definition:**

```sql
CREATE TABLE documents (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  content text NOT NULL,
  embedding vector(384) NOT NULL,
  metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now()
);
```

**Metadata Structure:**

The `metadata` column expects a JSON object with the following structure:

```json
{
  "source_type": "personal" | "project",
  "source_file": "path/to/file.md",  // e.g. "personal/bio.md" or "projects/project-name/index.md"
  "projectId": "string" | null,      // e.g. "project-name" or null for personal content
  "chunk_index": number,             // Index of the chunk in the source file
  "total_chunks": number             // Total number of chunks in the source file
}
```

## Functions

### `match_documents`

A PostgreSQL RPC function to perform vector similarity search.

**Parameters:**
- `query_embedding`: `vector(384)` - The embedding vector of the user's query
- `match_threshold`: `float` - Minimum similarity score (0-1) to return
- `match_count`: `int` - Maximum number of documents to return

**Returns:**
- Table with columns: `id`, `content`, `metadata`, `similarity`

**SQL Definition:**

```sql
CREATE OR REPLACE FUNCTION match_documents (
  query_embedding vector(384),
  match_threshold float,
  match_count int
) RETURNS TABLE (
  id uuid,
  content text,
  metadata jsonb,
  similarity float
) LANGUAGE plpgsql AS $$
BEGIN
  RETURN QUERY
  SELECT
    documents.id,
    documents.content,
    documents.metadata,
    1 - (documents.embedding <=> query_embedding) AS similarity
  FROM documents
  WHERE 1 - (documents.embedding <=> query_embedding) > match_threshold
  ORDER BY documents.embedding <=> query_embedding
  LIMIT match_count;
END;
$$;
```

## Indexes

To improve query performance:

1. **Metadata Index (GIN):** For filtering by `source_type` or `projectId`.
   ```sql
   CREATE INDEX ON documents USING gin (metadata);
   ```

2. **Vector Index (IVFFlat):** For approximate nearest neighbor search.
   ```sql
   CREATE INDEX ON documents USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
   ```

## Troubleshooting

**Error: `relation "documents" does not exist`**
- Run the migration script in `backend/sql/create-documents-table.sql` in the Supabase SQL Editor.

**Error: `function match_documents(...) does not exist`**
- Ensure you have executed the RPC function definition in Supabase.

**Error: `operator does not exist: vector <=> vector`**
- Ensure the `vector` extension is enabled (`CREATE EXTENSION vector;`).
