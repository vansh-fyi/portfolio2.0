<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.1">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.1</storyId>
    <title>RAG Backend Integration & Chat Functionality (Refined)</title>
    <status>drafted</status>
    <generatedAt>2025-11-21</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/2-1-rag-backend-integration-chat-functionality.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>verify and finalize the RAG integration</iWant>
    <soThat>the chat works in production with real data</soThat>
    <tasks>
      - Task 1: Verify Database & Data (AC: #3)
        - Run migration `001_create_embeddings_table.sql` on production Supabase
        - Verify `embeddings` table exists and has correct schema
        - Run ingestion script (to be created/verified) to populate data
        - Verify data presence in `embeddings` table

      - Task 2: Verify Backend API (AC: #1, #2)
        - Test `trpc.rag.query` endpoint with curl/Postman (or local script)
        - Verify `vectorQueryTool` is correctly invoked by Mastra agent
        - Verify response format matches frontend expectations

      - Task 3: End-to-End Verification (AC: #1, #2)
        - Test chat in deployed frontend (Vercel)
        - Verify personal context queries
        - Verify project context queries
        - Verify source citations in UI
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">
      <given>the deployed application</given>
      <when>I ask a question in the chat</when>
      <then>I receive a relevant response based on the context (personal/project)</then>
    </criterion>
    <criterion id="2">
      <and>the response sources are correctly cited (if applicable)</and>
    </criterion>
    <criterion id="3">
      <given>the backend database</given>
      <when>I check the `embeddings` table</when>
      <then>it is populated with vector data</then>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 2 Story 2.1 - RAG Backend Integration</section>
        <snippet>Refined story to focus on verification and finalization. Key tasks: Verify DB Migration, Verify Embeddings, Test tRPC Endpoint.</snippet>
      </doc>
      <doc>
        <path>backend/migrations/001_create_embeddings_table.sql</path>
        <title>Database Migration</title>
        <section>Schema Definition</section>
        <snippet>Creates `embeddings` table with `vector(384)` column. Defines `match_documents` RPC function for similarity search.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>backend/src/api/rag.ts</path>
        <kind>router</kind>
        <symbol>ragRouter</symbol>
        <lines>23-53</lines>
        <reason>The tRPC router handling RAG queries. Needs verification that it correctly calls `ursaAgent.generate`.</reason>
      </artifact>
      <artifact>
        <path>backend/src/tools/vector-query.ts</path>
        <kind>tool</kind>
        <symbol>vectorQueryTool</symbol>
        <lines>6-43</lines>
        <reason>The Mastra tool used by the agent to query Supabase. Needs verification that it calls `match_documents` RPC correctly.</reason>
      </artifact>
      <artifact>
        <path>vansh.fyi/src/hooks/useRAGQuery.ts</path>
        <kind>hook</kind>
        <symbol>useRAGQuery</symbol>
        <lines>15-32</lines>
        <reason>Frontend hook that calls the backend. Needs verification that it handles the response correctly.</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <pgvector>Database extension for vector similarity search</pgvector>
        <supabase-js>Client for interacting with Supabase</supabase-js>
        <mastra-core>Agent framework</mastra-core>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Migration must be run on the production Supabase instance.</constraint>
    <constraint>Data ingestion must populate the `embeddings` table before verification can succeed.</constraint>
    <constraint>Environment variables (SUPABASE_URL, SUPABASE_KEY) must be correctly set in Vercel.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>match_documents (RPC)</name>
      <kind>PostgreSQL Function</kind>
      <signature>
        FUNCTION match_documents(
          query_embedding vector(384),
          match_threshold float DEFAULT 0.7,
          match_count int DEFAULT 5,
          filter jsonb DEFAULT '{}'::jsonb
        ) RETURNS TABLE (...)
      </signature>
      <path>backend/migrations/001_create_embeddings_table.sql</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Verify in production environment (Vercel + Supabase). Use manual testing for UI and curl/script for API.
    </standards>
    <locations>
      backend/migrations/001_create_embeddings_table.sql
    </locations>
    <ideas>
      <test ac="3">Check Supabase dashboard for `embeddings` table and row count.</test>
      <test ac="1,2">Send a curl request to `trpc.rag.query` with a known question.</test>
      <test ac="1,2">Open the deployed site, navigate to a project, and ask "What is this project about?".</test>
    </ideas>
  </tests>
</story-context>
