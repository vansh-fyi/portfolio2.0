<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>2</storyId>
    <title>Lead-Gen Conversational Flow</title>
    <status>drafted</status>
    <generatedAt>2025-11-19</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/3-2-lead-gen-conversational-flow.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer</asA>
    <iWant>to implement a structured conversational flow for the lead-gen agent</iWant>
    <soThat>it can collect the necessary information from users</soThat>
    <tasks>
      - Task 1: Define Conversational Flow State Machine (AC: #1, #2, #3)
      - Task 2: Implement Greeting Message (AC: #1, #3)
      - Task 3: Build Name Collection Flow (AC: #2, #3)
      - Task 4: Build Email Collection Flow (AC: #2, #3)
      - Task 5: Build Project Details Collection Flow (AC: #2, #3)
      - Task 6: Build Confirmation & Summary Flow (AC: #2, #3)
      - Task 7: Add Error Handling & Edge Cases (AC: #2, #3)
      - Task 8: Apply Ursa Personality Throughout (AC: #3)
      - Task 9: Write Conversational Flow Tests (AC: #1, #2, #3)
      - Task 10: Update Existing Tests (AC: #1, #2, #3)
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Given the lead-gen chat component is loaded, when the user first sees the chat, then the agent sends an introductory message: "Hi! I am Ursa. Please mention your requirements."</ac>
    <ac id="2">And the agent guides the user through a series of questions to collect their name, email, and project details.</ac>
    <ac id="3">And the agent's responses adhere to the "Ursa" personality.</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Ursa - Lead Generation Agent</section>
        <snippet>FR13: The agent in the contact section, also named "Ursa," must be able to collect contact information and project inquiries from potential clients. FR14: The lead generation agent's responses must adhere to the defined "Ursa" personality. FR16: This agent must not use the RAG system and should follow a more structured conversational flow for data collection, implemented using the Mastra.AI framework.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 3.2: Lead-Gen Conversational Flow</section>
        <snippet>As a developer, I want to implement a structured conversational flow for the lead-gen agent, so that it can collect the necessary information from users. The agent guides the user through a series of questions to collect their name, email, and project details. The agent's responses adhere to the "Ursa" personality.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Implementation Patterns - Communication Patterns</section>
        <snippet>Frontend State Management: Zustand stores implemented for view routing, theme management, and chat context. For local component state, use React's built-in useState and useReducer hooks.</snippet>
      </doc>
      <doc>
        <path>docs/ursa-personality-guide.md</path>
        <title>Ursa Personality Guide (PRIMARY REFERENCE)</title>
        <section>Complete Personality Definition</section>
        <snippet>Tone: Conversational, authentic, and passionate. Voice: Strongly first-person ("I"). Vocabulary: Clear, direct language with informal touches (contractions, casual phrases). Emoji Usage: Strategic, max 1-2 per response. Key characteristics: conversational not formal, use contractions ("I'm", "didn't", "you'll"), friendly emoji, direct personal language, avoid corporate/robotic phrases.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/stories/3-1-lead-gen-chat-ui.md</path>
        <title>Story 3.1 - Lead-Gen Chat UI (COMPLETED)</title>
        <section>Dev Agent Record - Completion Notes</section>
        <snippet>Delivered Infrastructure: LeadGenChat component with Message interface, state management (messages, inputValue, isLoading), placeholder handleSend function, auto-scroll behavior, input validation, loading states. Glass morphism styling with backdrop-blur-xl, dark mode compatible. 15 test cases established with React Testing Library patterns. Component integrated into Contact.tsx right column.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>portfolio-react-template/src/components/LeadGenChat.tsx</path>
        <kind>component</kind>
        <symbol>LeadGenChat</symbol>
        <lines>1-232</lines>
        <reason>PRIMARY FILE TO EXTEND - Contains the existing chat UI component with Message interface, state management (messages, inputValue, isLoading), and placeholder handleSend function (lines 37-63) that needs replacement with conversation flow logic. Initial greeting message (lines 19-25) needs update to match AC #1.</reason>
      </artifact>
      <artifact>
        <path>portfolio-react-template/src/components/LeadGenChat.tsx</path>
        <kind>interface</kind>
        <symbol>Message</symbol>
        <lines>4-8</lines>
        <reason>REUSE this interface - Message type with sender ('user' | 'agent'), text (string), timestamp (optional Date). Do not modify this interface.</reason>
      </artifact>
      <artifact>
        <path>portfolio-react-template/src/components/LeadGenChat.tsx</path>
        <kind>function</kind>
        <symbol>handleSend</symbol>
        <lines>37-63</lines>
        <reason>REPLACE this function - Current placeholder response logic needs to be replaced with conversation state machine. Function validates input, adds user message to history, clears input, simulates agent response with 1s delay. New logic should follow state machine pattern: GREETING → NAME → EMAIL → PROJECT_DETAILS → CONFIRMATION → COMPLETE.</reason>
      </artifact>
      <artifact>
        <path>portfolio-react-template/src/components/__tests__/LeadGenChat.test.tsx</path>
        <kind>test</kind>
        <symbol>LeadGenChat Component Tests</symbol>
        <lines>1-194</lines>
        <reason>UPDATE these tests - 15 existing test cases that expect placeholder response behavior. Tests need updating for: initial greeting message (line 34 expects "Hi there!" but AC #1 requires "Hi! I am Ursa. Please mention your requirements."), agent response expectations (line 191 expects placeholder text), and new conversation state structure. All existing tests must continue to pass.</reason>
      </artifact>
      <artifact>
        <path>portfolio-react-template/src/components/Contact.tsx</path>
        <kind>component</kind>
        <symbol>Contact</symbol>
        <lines>1-73</lines>
        <reason>CONTEXT ONLY - Shows how LeadGenChat is integrated in the Contact section (embedded in right column, lg:col-span-3). No changes needed to this file.</reason>
      </artifact>
      <artifact>
        <path>portfolio-react-template/src/state/themeStore.ts</path>
        <kind>store</kind>
        <symbol>useThemeStore</symbol>
        <lines>all</lines>
        <reason>CONTEXT ONLY - LeadGenChat already imports and uses themeStore for consistency. No changes needed.</reason>
      </artifact>
    </code>
    <dependencies>
      <npm>
        <package name="react" version="^19.2.0" />
        <package name="react-dom" version="^19.2.0" />
        <package name="typescript" version="~5.9.3" />
        <package name="zustand" version="^5.0.8" />
        <package name="@testing-library/react" version="^16.3.0" />
        <package name="@testing-library/jest-dom" version="^6.9.1" />
        <package name="jest" version="^30.2.0" />
        <package name="jest-environment-jsdom" version="^30.2.0" />
        <package name="ts-jest" version="^29.4.5" />
      </npm>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">DO NOT recreate LeadGenChat component - extend existing file at portfolio-react-template/src/components/LeadGenChat.tsx</constraint>
    <constraint type="styling">DO NOT change styling - maintain exact same Tailwind classes and visual appearance established in Story 3.1</constraint>
    <constraint type="interface">DO NOT modify Message interface - reuse existing { sender: 'user' | 'agent', text: string, timestamp?: Date }</constraint>
    <constraint type="state">REUSE existing state patterns (messages, inputValue, isLoading) and ADD conversationState for flow management</constraint>
    <constraint type="component-location">Component stays at src/components/LeadGenChat.tsx (NOT in overlays/ subfolder)</constraint>
    <constraint type="testing">UPDATE all 15 existing tests to work with new conversation flow - no test regressions allowed</constraint>
    <constraint type="personality">ALL agent responses MUST follow Ursa personality guide (docs/ursa-personality-guide.md): conversational, authentic, passionate, first-person, strategic emoji (max 1-2), avoid corporate/robotic phrasing</constraint>
    <constraint type="backend">NO backend integration in this story - Story 3.3 will add email API connection</constraint>
    <constraint type="dependencies">NO new external dependencies needed - use existing React, TypeScript, and testing libraries</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Message</name>
      <kind>TypeScript interface</kind>
      <signature>interface Message { sender: 'user' | 'agent'; text: string; timestamp?: Date; }</signature>
      <path>portfolio-react-template/src/components/LeadGenChat.tsx</path>
    </interface>
    <interface>
      <name>ConversationStep (NEW - to be created)</name>
      <kind>TypeScript type</kind>
      <signature>type ConversationStep = 'GREETING' | 'NAME' | 'EMAIL' | 'PROJECT_DETAILS' | 'CONFIRMATION' | 'COMPLETE';</signature>
      <path>portfolio-react-template/src/components/LeadGenChat.tsx</path>
    </interface>
    <interface>
      <name>CollectedData (NEW - to be created)</name>
      <kind>TypeScript interface</kind>
      <signature>interface CollectedData { name?: string; email?: string; projectDetails?: string; }</signature>
      <path>portfolio-react-template/src/components/LeadGenChat.tsx</path>
    </interface>
    <interface>
      <name>ConversationState (NEW - to be created)</name>
      <kind>TypeScript interface</kind>
      <signature>interface ConversationState { currentStep: ConversationStep; collectedData: CollectedData; }</signature>
      <path>portfolio-react-template/src/components/LeadGenChat.tsx</path>
    </interface>
    <interface>
      <name>handleSend (MODIFIED)</name>
      <kind>Function</kind>
      <signature>const handleSend = async () => void</signature>
      <path>portfolio-react-template/src/components/LeadGenChat.tsx</path>
    </interface>
    <interface>
      <name>processConversationStep (NEW - to be created)</name>
      <kind>Function</kind>
      <signature>const processConversationStep = async (userInput: string, state: ConversationState): Promise&lt;Message&gt;</signature>
      <path>portfolio-react-template/src/components/LeadGenChat.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Testing with Jest and React Testing Library. All tests in __tests__/ subdirectories. Use React Testing Library queries (getByRole, getByLabelText, getByText). Async handling with waitFor. beforeEach cleanup. Test user interactions, state transitions, and accessibility. All existing tests must pass with no regressions.</standards>
    <locations>portfolio-react-template/src/components/__tests__/</locations>
    <ideas>
      <testIdea ac="1">Test: Initial greeting message displays "Hi! I am Ursa. Please mention your requirements." when component mounts</testIdea>
      <testIdea ac="2">Test: Name collection - input "I'm John" extracts "John" and advances to EMAIL step</testIdea>
      <testIdea ac="2">Test: Name collection - input "John" extracts "John" and advances to EMAIL step</testIdea>
      <testIdea ac="2">Test: Email collection - valid email "john@example.com" accepted and advances to PROJECT_DETAILS</testIdea>
      <testIdea ac="2">Test: Email validation - invalid email "invalid-email" shows error and stays on EMAIL step</testIdea>
      <testIdea ac="2">Test: Project details collection - any text input stored correctly and advances to CONFIRMATION</testIdea>
      <testIdea ac="2">Test: Confirmation step - summary displays all collected data (name, email, project details)</testIdea>
      <testIdea ac="2">Test: Full conversation flow - complete journey from GREETING to COMPLETE</testIdea>
      <testIdea ac="2">Test: Error handling - unclear inputs trigger clarifying questions</testIdea>
      <testIdea ac="3">Test: All agent responses match Ursa personality (conversational, first-person, strategic emoji)</testIdea>
      <testIdea ac="1,2,3">Update: Modify 15 existing tests expecting placeholder responses to work with new conversation flow</testIdea>
    </ideas>
  </tests>
</story-context>
