<story-context id="portfolio2.0/docs/sprint-artifacts/4-5-email-api-endpoint.context" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>5</storyId>
    <title>Email API Endpoint</title>
    <status>drafted</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-5-email-api-endpoint.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to implement a backend API endpoint for sending emails</iWant>
    <soThat>the lead generation agent can deliver form submissions to Vansh via email</soThat>
    <tasks>
- [ ] Install Resend SDK (AC: 1)
  - [ ] Add `resend` package to backend dependencies
  - [ ] Verify Resend API key is configured in `config.ts` (from Story 4.3)
- [ ] Implement Email Service (AC: 1)
  - [ ] Create `backend/src/services/email.ts`
  - [ ] Initialize Resend client with API key from config
  - [ ] Implement `sendLeadEmail()` function with typed parameters (name, email, message)
  - [ ] Format email content with lead details
  - [ ] Handle Resend API errors with descriptive messages
- [ ] Create tRPC Email Router (AC: 1)
  - [ ] Create `backend/src/api/email.ts` for email router
  - [ ] Define `trpc.email.sendLead` procedure with input validation (Zod schema)
  - [ ] Connect procedure to email service
  - [ ] Return success/error response in standard format
- [ ] Test Email Sending (AC: 1)
  - [ ] Manually test endpoint with sample lead data
  - [ ] Verify email received at configured address
  - [ ] Test error handling (invalid API key, malformed data)
  - [ ] Verify proper error responses returned to client
    </tasks>
  </story>

  <acceptanceCriteria>
1.  **Given** the backend service receives a request with lead generation form data
    *   **When** the service processes the request
    *   **Then** the service sends an email to Vansh's specified address using Resend API.
    *   **And** the service returns a success or failure response.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Communication Patterns</section>
        <snippet>
**Frontend-Backend**: Exclusively tRPC procedures for all API communication.
        </snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 4.5: Email API Endpoint</section>
        <snippet>
**Use Resend Node.js SDK directly for email delivery** (not Mastra.AI). The tRPC endpoint `trpc.email.sendLead` will call Resend API with proper error handling. Mastra.AI is reserved for RAG (conversational AI) functionality only. Store Resend API key securely in backend environment variables.
        </snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/src/services/config.ts</path>
        <kind>configuration module</kind>
        <symbol>config.resendApiKey</symbol>
        <lines>61-65</lines>
        <reason>Resend API key already configured from Story 4.3, ready for use</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="resend" version="latest" note="Resend Node.js SDK for email delivery" />
        <package name="zod" version="latest" note="For tRPC input validation schemas" />
        <package name="@trpc/server" version="latest" note="For tRPC router and procedures" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use Resend SDK directly (NOT Mastra.AI)</constraint>
    <constraint>Implement tRPC endpoint: trpc.email.sendLead</constraint>
    <constraint>Use Resend API key from config.ts (Story 4.3)</constraint>
    <constraint>Input validation with Zod schema</constraint>
    <constraint>Return standard success/error response format</constraint>
    <constraint>Email recipient: Vansh's configured address</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Email Service Interface</name>
      <kind>TypeScript function</kind>
      <signature>sendLeadEmail(data: { name: string; email: string; message: string }): Promise&lt;{ success: boolean; error?: string }&gt;</signature>
      <path>backend/src/services/email.ts</path>
    </interface>
    <interface>
      <name>tRPC Email Router</name>
      <kind>tRPC procedure</kind>
      <signature>trpc.email.sendLead.mutate({ name, email, message })</signature>
      <path>backend/src/api/email.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Manual testing with sample lead data. Verify email delivery to configured address. Test error handling for invalid API key and malformed data. Verify proper error responses returned to client. Integrates with frontend from Story 3.3.
    </standards>
    <locations>
      <location>Manual verification: Send test request with valid lead data</location>
      <location>Email inbox: Verify email received with correct formatting</location>
      <location>Error testing: Test with invalid API key, missing fields</location>
    </locations>
    <ideas>
      <idea>Test sendLeadEmail() with valid lead data → email received</idea>
      <idea>Test tRPC endpoint with valid input → success response</idea>
      <idea>Test with invalid API key → descriptive error returned</idea>
      <idea>Test with missing required fields → validation error</idea>
      <idea>Verify email format includes name, email, message</idea>
    </ideas>
  </tests>
</story-context>
