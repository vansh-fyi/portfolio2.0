<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.1">
  <metadata>
    <epicId>4</epicId>
    <storyId>4.2</storyId>
    <title>Vector Database & Ingestion (Refined)</title>
    <status>drafted</status>
    <generatedAt>2025-11-21</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/4-2-vector-database-ingestion.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>execute the database migration and verify the ingestion script</iWant>
    <soThat>the vector database is correctly populated for the RAG agent</soThat>
    <tasks>
      - Task 1: Execute Migration (AC: #1, #2)
        - Connect to Supabase SQL Editor or use CLI
        - Run `backend/migrations/001_create_embeddings_table.sql`
        - Verify `match_documents` function exists with correct arguments

      - Task 2: Verify Ingestion Script (AC: #3)
        - Run `npm run ingest` (or equivalent command)
        - Check for errors during processing
        - Verify row count in `embeddings` table matches file count/chunks

      - Task 3: Verify Retrieval (AC: #4)
        - Use a test script or the `VectorQueryTool` directly to perform a similarity search
        - Ensure results are relevant to the query
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">
      <given>the Supabase instance</given>
      <when>I run the migration `001_create_embeddings_table.sql`</when>
      <then>the `embeddings` table and `match_documents` function are created</then>
    </criterion>
    <criterion id="2">
      <and>the `match_documents` function signature matches what `VectorQueryTool` expects</and>
    </criterion>
    <criterion id="3">
      <given>the `ingest-data.ts` script</given>
      <when>I run it</when>
      <then>it successfully processes `_content/` files and inserts embeddings into Supabase</then>
    </criterion>
    <criterion id="4">
      <and>I can query the data using the `VectorQueryTool`</and>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 4.2: Vector Database & Ingestion</section>
        <snippet>Execute `001_create_embeddings_table.sql` on Supabase. Build a script to read `_content/*.md` and insert embeddings.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>backend/migrations/001_create_embeddings_table.sql</path>
        <kind>migration</kind>
        <symbol>match_documents</symbol>
        <lines>30-58</lines>
        <reason>The RPC function that must be created in Supabase. Critical for RAG retrieval.</reason>
      </artifact>
      <artifact>
        <path>backend/src/scripts/ingest-data.ts</path>
        <kind>script</kind>
        <symbol>ingestData</symbol>
        <lines>7-55</lines>
        <reason>Main script to run for ingestion. Iterates sources and upserts embeddings.</reason>
      </artifact>
      <artifact>
        <path>backend/src/tools/vector-query.ts</path>
        <kind>tool</kind>
        <symbol>vectorQueryTool</symbol>
        <lines>6-43</lines>
        <reason>Tool used to verify retrieval. Calls `match_documents` RPC.</reason>
      </artifact>
      <artifact>
        <path>backend/src/services/ingestion/markdown-source.ts</path>
        <kind>source</kind>
        <symbol>MarkdownSource</symbol>
        <lines>5-68</lines>
        <reason>Logic for reading markdown files from `_content/`. Verifies file reading.</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.x" />
        <package name="@mastra/core" version="^0.1.x" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Migration must be run on the production Supabase instance.</constraint>
    <constraint>Ingestion script must handle errors gracefully (e.g., failed chunks).</constraint>
    <constraint>Retrieval must use the `match_documents` RPC function.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>match_documents</name>
      <kind>PostgreSQL Function</kind>
      <signature>
        match_documents(
          query_embedding vector(384),
          match_threshold float,
          match_count int,
          filter jsonb
        )
      </signature>
      <path>backend/migrations/001_create_embeddings_table.sql</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Manual verification via CLI/Script.
    </standards>
    <locations>
      backend/src/scripts/
    </locations>
    <ideas>
      <test ac="1">Check Supabase dashboard for `embeddings` table.</test>
      <test ac="3">Run `ts-node backend/src/scripts/ingest-data.ts` and check logs.</test>
      <test ac="4">Create a small script to call `vectorQueryTool.execute({ context: { query: 'test', context: 'personal' } })`.</test>
    </ideas>
  </tests>
</story-context>
