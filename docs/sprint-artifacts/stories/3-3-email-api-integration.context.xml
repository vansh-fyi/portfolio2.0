<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.1">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.3</storyId>
    <title>Email API Integration (Fixes Required)</title>
    <status>drafted</status>
    <generatedAt>2025-11-21</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/3-3-email-api-integration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>fix the email sending logic</iWant>
    <soThat>it works securely in production without hardcoded values</soThat>
    <tasks>
      - Task 1: Fix Hardcoded Email (AC: #1, #3)
        - Modify `backend/src/services/email.ts` to use `process.env.CONTACT_EMAIL`
        - Add `CONTACT_EMAIL` to `.env` and `.env.example`
        - Ensure fallback or error if env var is missing

      - Task 2: Verify Resend Key Configuration (AC: #2)
        - Audit `backend/src/services/email.ts` to ensure it uses `process.env.RESEND_API_KEY`
        - Verify Vercel project settings have the correct key

      - Task 3: Test Email Sending (AC: #1)
        - Verify `trpc.email.sendLead` works in local development
        - Verify it works in production (after deployment)
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">
      <given>the contact form</given>
      <when>I submit a lead</when>
      <then>an email is sent to the address configured in `CONTACT_EMAIL`</then>
    </criterion>
    <criterion id="2">
      <and>the `RESEND_API_KEY` is securely loaded from environment variables</and>
    </criterion>
    <criterion id="3">
      <and>no email addresses are hardcoded in the source code</and>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 3.3: Email API Integration (Fixes Required)</section>
        <snippet>Fix hardcoded email addresses and ensure secure API key usage. Move recipient email from `services/email.ts` to environment variable `CONTACT_EMAIL`.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>backend/src/services/email.ts</path>
        <kind>code</kind>
        <symbol>sendLeadEmail</symbol>
        <lines>12</lines>
        <reason>Contains hardcoded `RECIPIENT_EMAIL = 'vansh.s.bhatia@gmail.com'`. Needs to be replaced with `process.env.CONTACT_EMAIL`.</reason>
      </artifact>
      <artifact>
        <path>backend/.env.example</path>
        <kind>config</kind>
        <symbol>Environment Variables</symbol>
        <lines>14-16</lines>
        <reason>Needs `CONTACT_EMAIL` added to the example configuration.</reason>
      </artifact>
      <artifact>
        <path>backend/src/api/email.ts</path>
        <kind>code</kind>
        <symbol>emailRouter</symbol>
        <lines>23-50</lines>
        <reason>The tRPC router that calls the email service. Useful context for testing.</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="resend" version="^4.0.0" />
        <package name="dotenv" version="^16.4.5" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must use `process.env.CONTACT_EMAIL` for the recipient address.</constraint>
    <constraint>Must fail gracefully if `CONTACT_EMAIL` is not defined.</constraint>
    <constraint>Do not commit real email addresses to version control.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Environment Variables</name>
      <kind>Configuration</kind>
      <signature>
        CONTACT_EMAIL=string
        RESEND_API_KEY=string
      </signature>
      <path>backend/.env</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Manual verification of environment variable loading and email delivery.
    </standards>
    <locations>
      backend/src/services/email.ts
    </locations>
    <ideas>
      <test ac="1">Set `CONTACT_EMAIL` to a test address and verify email is delivered there.</test>
      <test ac="3">Grep codebase for 'vansh.s.bhatia@gmail.com' to ensure it's removed.</test>
    </ideas>
  </tests>
</story-context>
