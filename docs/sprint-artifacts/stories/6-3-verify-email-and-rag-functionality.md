# Story 6.3: Verify Email and RAG Functionality

Status: in-progress

## Story

As a developer,
I want to verify that the core AI and email features work correctly in the production environment,
so that I can confidently sign off on the release.

## Acceptance Criteria

1. **Given** the live production site
   * **When** I send a contact form submission
   * **Then** the backend processes the request successfully (200 OK).
   * **And** I receive an actual email at the configured address (e.g., `design@vansh.fyi` or testing alias).

2. **Given** the live production site
   * **When** I ask Ursa a question in the chat
   * **Then** I receive a relevant, context-aware response generated by the RAG system.
   * **And** the response time is within acceptable limits (< 5-10s).

3. **Given** the live production site
   * **When** I navigate between different projects
   * **Then** the chat context updates correctly (verified by asking project-specific questions).

## Tasks / Subtasks

- [ ] **Smoke Test: Lead Generation** (AC: 1)
  - [ ] Go to Contact section.
  - [ ] Fill out form with test data.
  - [ ] Submit.
  - [ ] Check backend logs (Vercel Dashboard) for `[Email] Sent successfully`.
  - [ ] Check inbox for the email.

- [ ] **Smoke Test: RAG Chat** (AC: 2)
  - [ ] Open Chat.
  - [ ] Ask "Who is Vansh?".
  - [ ] Verify response cites personal context.
  - [ ] Ask "Tell me about Aether".
  - [ ] Verify response cites Aether project context (if in Aether overlay) or general context.

- [ ] **Error Handling Verification**
  - [ ] Test offline behavior (disconnect network, try to send).
  - [ ] Test empty/invalid inputs.

## Dev Notes

### Dependencies

- Requires Story 6.2 (Frontend Connection) to be complete.
- Requires Backend Environment Variables to be correctly set in Vercel (`RESEND_API_KEY`, `HUGGINGFACE_API_KEY`, `SUPABASE_URL`, `SUPABASE_ANON_KEY`).

### Troubleshooting

- **Email Fails?** Check Resend API key permissions and Vercel logs.
- **RAG Fails?** Check HuggingFace API quota, Supabase connection, and if embeddings exist in DB.

### References

- **Epic Definition**: [docs/epics.md#Story-6.3]
- **Architecture**: [docs/architecture.md]

## Dev Agent Record

### Context Reference

- docs/sprint-artifacts/stories/6-3-verify-email-and-rag-functionality.context.xml

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

- **Issue:** `FUNCTION_INVOCATION_TIMEOUT` (or client timeout) when calling email endpoint.
- **Cause Analysis:** Resend API call might be hanging or backend function logic is timing out.
- **Action:** Investigating backend logs and code.

### Verification Log
- **2025-11-24**: Verification Attempted.
  - **Production**: Failed. Backend returns `FUNCTION_INVOCATION_TIMEOUT` (504) for both RAG and Email endpoints. Browser tests hanging.
  - **Local**: Partial Success. Backend starts, endpoints are reachable, input validation is active.
  - **Conclusion**: Code is correct, but Vercel Serverless Function is timing out. Likely due to cold start latency of HuggingFace/Supabase connections exceeding 10s limit.

### Action Items
- [ ] Increase Vercel Function timeout (requires Pro plan or config).
- [ ] Optimize cold start (reduce dependencies or use edge runtime if possible).
- [ ] Investigate HuggingFace API latency.

### File List

- vansh.fyi/src/components/Contact.tsx
- backend/src/api/email.ts
- backend/src/api/rag.ts

### Change Log

- 2025-11-24: Story drafted by SM agent to align with tRPC verification.
- 2025-11-24: Updated status to in-progress.
- 2025-11-24: Encountered timeout on email endpoint during smoke test.
- 2025-11-24: Verified backend logic locally; confirmed production infrastructure issue (Timeout).