<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.1">
  <metadata>
    <epicId>4</epicId>
    <storyId>4.3</storyId>
    <title>Secure API Key Management (Audit & Verification)</title>
    <status>drafted</status>
    <generatedAt>2025-11-21</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/4-3-secure-api-key-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>audit and verify the secure management of API keys</iWant>
    <soThat>I can be confident no secrets are exposed and the application runs correctly in production</soThat>
    <tasks>
      - Task 1: Codebase Secret Audit (AC: #1)
        - Run `grep` or a secret scanning tool to ensure no keys (sk-..., hf_..., re_...) are committed
        - Verify `.env` is in `.gitignore`

      - Task 2: Verify Config Module (AC: #2)
        - Review `backend/src/services/config.ts` to ensure it includes all necessary keys
        - Verify runtime validation logic (fail-fast)

      - Task 3: Vercel Environment Check (AC: #3)
        - Verify Vercel project settings have all keys matching `.env.example`
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">
      <given>the codebase</given>
      <when>I audit for secrets</when>
      <then>no API keys are found hardcoded in the source</then>
    </criterion>
    <criterion id="2">
      <given>the `backend/src/services/config.ts` module</given>
      <when>the application starts</when>
      <then>it correctly validates and loads all required environment variables (`HUGGINGFACE_API_KEY`, `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `RESEND_API_KEY`)</then>
    </criterion>
    <criterion id="3">
      <given>the Vercel project</given>
      <when>I check the settings</when>
      <then>all required environment variables are defined</then>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 4.3: Secure API Key Management</section>
        <snippet>Audit codebase for hardcoded secrets. Verify environment variable configuration in Vercel.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>backend/src/services/config.ts</path>
        <kind>code</kind>
        <symbol>config</symbol>
        <lines>39-66</lines>
        <reason>The central configuration object that must be verified.</reason>
      </artifact>
      <artifact>
        <path>backend/.env.example</path>
        <kind>config</kind>
        <symbol>Environment Variables</symbol>
        <lines>1-16</lines>
        <reason>The reference for required environment variables.</reason>
      </artifact>
      <artifact>
        <path>backend/.gitignore</path>
        <kind>config</kind>
        <symbol>.env</symbol>
        <lines>2</lines>
        <reason>Must include `.env` to prevent accidental commit.</reason>
      </artifact>
    </code>
  </artifacts>

  <constraints>
    <constraint>No API keys in source code.</constraint>
    <constraint>Server must fail to start if keys are missing.</constraint>
  </constraints>

  <tests>
    <standards>
      Manual audit and verification.
    </standards>
    <locations>
      backend/src/
    </locations>
    <ideas>
      <test ac="1">Run `grep -r "sk-" .` and other patterns.</test>
      <test ac="2">Try starting the server with missing env vars and verify it fails.</test>
    </ideas>
  </tests>
</story-context>
