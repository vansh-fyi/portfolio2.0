<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>2</storyId>
    <title>Mobile Interaction Stability</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/7-2-mobile-interaction-stability.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>touch interactions and scrolling to be smooth without jank or crashes</iWant>
    <soThat>the mobile experience is premium and reliable</soThat>
    <tasks>
      - Task 1 (Passive Scroll Handlers): Audit all scroll event listeners and ensure they use `{ passive: true }` option where appropriate
        - Subtask 1.1: Identify all scroll event listeners in components
        - Subtask 1.2: Apply passive option to non-blocking scroll listeners
        - Subtask 1.3: Test scroll performance on mobile after changes
      - Task 2 (Touch Event Conflicts): Resolve any conflicting touch/scroll interactions that cause jank
        - Subtask 2.1: Test all interactive elements on mobile (buttons, overlays, chat input)
        - Subtask 2.2: Fix any touch event propagation issues
        - Subtask 2.3: Ensure overlay transitions don't block main thread
      - Task 3 (Verify Stability): Run extended mobile stress test (10+ minutes) to confirm no crashes/reloads
        - Subtask 3.1: Test main page scrolling for extended period
        - Subtask 3.2: Test overlay interactions (open/close repeatedly)
        - Subtask 3.3: Test chat interactions (multiple messages, long sessions)
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Smooth Scrolling: Scrolling throughout the application (main page, overlays) is smooth without jank on mobile devices</criterion>
    <criterion id="AC2">Responsive Touch: Touch interactions (taps, swipes) respond immediately without lag or missed inputs</criterion>
    <criterion id="AC3">Overlay Stability: Opening and interacting with overlays (projects, chat) does not cause crashes or "Aw Snap" errors</criterion>
    <criterion id="AC4">No Browser Reloads: Extended mobile usage (10+ minutes) does not trigger automatic page reloads or crashes</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <item>
        <path>docs/sprint-artifacts/stories/7-1-verify-mobile-stability-post-optimization.md</path>
        <title>Story 7.1 - Performance Optimization Patterns</title>
        <section>Dev Agent Record - Completion Notes</section>
        <snippet>Established mobile-specific optimization patterns via media queries (@media max-width: 768px). Added @tanstack/react-virtual for performance-critical list rendering. Demonstrated cleanup patterns in App.tsx lines 78-82. Critical constraint: UI must remain visually unchanged.</snippet>
      </item>
      <item>
        <path>docs/epics.md</path>
        <title>Epic 7: Mobile Optimization & Performance</title>
        <section>Story 7.2: Mobile Interaction Stability</section>
        <snippet>Ensure touch interactions and scrolling are smooth without jank or crashes. Optimize scroll handlers with passive option. Resolve touch/scroll conflicts. Target: smooth 60fps experience on mobile.</snippet>
      </item>
    </docs>

    <code>
      <item>
        <path>vansh.fyi/src/components/overlays/ProjectOverlay.tsx</path>
        <kind>component</kind>
        <symbol>ProjectView</symbol>
        <reason>Primary overlay component with transitions and iframe rendering. Needs audit for touch event handling and scroll performance on mobile.</reason>
      </item>
      <item>
        <path>vansh.fyi/src/components/overlays/ChatOverlay.tsx</path>
        <kind>component</kind>
        <symbol>ChatView</symbol>
        <reason>Already optimized with virtualization in Story 7.1. Uses @tanstack/react-virtual with chatContainerRef. Verify passive scroll handlers and touch input responsiveness.</reason>
      </item>
      <item>
        <path>vansh.fyi/src/components/overlays/OverlaySidebar.tsx</path>
        <kind>component</kind>
        <symbol>OverlaySidebar</symbol>
        <reason>Project list sidebar with scroll interactions. Needs audit for passive scroll listeners.</reason>
      </item>
      <item>
        <path>vansh.fyi/src/components/Contact.tsx</path>
        <kind>component</kind>
        <symbol>Contact</symbol>
        <reason>Contains LeadGenChat component with touch input (textarea, buttons). Verify touch event responsiveness and no propagation conflicts.</reason>
      </item>
      <item>
        <path>vansh.fyi/src/App.tsx</path>
        <kind>component</kind>
        <symbol>App</symbol>
        <lines>30-46</lines>
        <reason>View-state routing system and theme management. Contains body-lock class toggle on line 32-36 that affects scroll behavior. Unicorn Studio cleanup patterns at lines 78-82.</reason>
      </item>
      <item>
        <path>vansh.fyi/src/state/overlayStore.ts</path>
        <kind>store</kind>
        <symbol>useViewStore</symbol>
        <reason>Zustand store managing view transitions (main/projects/chat). View changes trigger re-renders that could affect mobile performance.</reason>
      </item>
      <item>
        <path>vansh.fyi/src/index.css</path>
        <kind>styling</kind>
        <symbol>.body-lock</symbol>
        <lines>621-625</lines>
        <reason>Scroll locking mechanism for overlays. Verify it doesn't conflict with touch events or cause jank during transitions.</reason>
      </item>
      <item>
        <path>vansh.fyi/src/index.css</path>
        <kind>styling</kind>
        <symbol>Mobile GPU optimization</symbol>
        <lines>627-645</lines>
        <reason>Mobile-specific performance optimization established in Story 7.1. Pattern to follow for additional mobile optimizations.</reason>
      </item>
    </code>

    <dependencies>
      <npm>
        <package name="react" version="^19.2.0">Core React library</package>
        <package name="react-dom" version="^19.2.0">React DOM rendering</package>
        <package name="react-scroll" version="^1.9.3">Smooth scrolling library for main page navigation</package>
        <package name="@tanstack/react-virtual" version="^3.13.12">Virtualization library added in Story 7.1 for performance</package>
        <package name="zustand" version="^5.0.8">State management for view routing</package>
        <package name="web-vitals" version="^5.1.0">Performance monitoring - can measure scroll performance</package>
      </npm>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <type>UI Preservation</type>
      <description>Visual design and UI elements must remain unchanged. Optimizations are internal only - no user-facing changes allowed.</description>
    </constraint>
    <constraint>
      <type>Performance Target</type>
      <description>Target >30fps for all interactions (established in Story 7.1 AC1). Scroll and touch interactions must maintain smooth 60fps on mobile devices.</description>
    </constraint>
    <constraint>
      <type>Mobile-First Approach</type>
      <description>Use media queries (@media max-width: 768px) for device-specific optimizations. Pattern established in index.css lines 627-645.</description>
    </constraint>
    <constraint>
      <type>React Best Practices</type>
      <description>Use passive event listeners for scroll handlers. Avoid main thread blocking. Follow cleanup patterns demonstrated in App.tsx:78-82.</description>
    </constraint>
    <constraint>
      <type>Testing Requirements</type>
      <description>Build verification + manual mobile device testing required. No automated performance tests currently exist. Extended 10+ minute stress testing required per AC4.</description>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>addEventListener with passive option</name>
      <kind>DOM API</kind>
      <signature>element.addEventListener(type, listener, { passive: true })</signature>
      <path>Web API - applies to all scroll/touch event handlers</path>
    </interface>
    <interface>
      <name>useVirtualizer</name>
      <kind>React Hook</kind>
      <signature>const virtualizer = useVirtualizer({ count, getScrollElement, estimateSize, overscan })</signature>
      <path>vansh.fyi/src/components/overlays/ChatOverlay.tsx:25-30</path>
    </interface>
    <interface>
      <name>useViewStore</name>
      <kind>Zustand Store Hook</kind>
      <signature>const { currentView, goToMain, goToProjects, goToChat } = useViewStore()</signature>
      <path>vansh.fyi/src/state/overlayStore.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing framework: Jest with React Testing Library (@testing-library/react ^16.3.0, @testing-library/jest-dom ^6.9.1). Test files located in __tests__ directories alongside components. Current tests exist for ChatOverlay and ProjectOverlay. Manual mobile device testing required for performance validation. Build verification via `npm run build` ensures no compilation errors.
    </standards>
    <locations>
      - vansh.fyi/src/components/overlays/__tests__/
      - vansh.fyi/src/components/__tests__/ (if exists)
    </locations>
    <ideas>
      <idea criterion="AC1">Test: Verify no scroll event listeners exist without passive option. Manual: Test smooth scrolling on physical mobile device in main page, overlays, and chat.</idea>
      <idea criterion="AC2">Manual: Test all interactive elements on mobile - buttons respond immediately, chat textarea doesn't lag, overlay close buttons work instantly.</idea>
      <idea criterion="AC3">Manual: Repeatedly open/close overlays (projects, chat) 20+ times on mobile without crashes. Test transitions between all view states.</idea>
      <idea criterion="AC4">Manual: Leave site open on mobile device for 15 minutes with periodic interactions (scroll, open overlays, send chat messages). Verify no automatic reloads or memory crashes.</idea>
    </ideas>
  </tests>
</story-context>
