<story-context id="portfolio2.0/docs/sprint-artifacts/4-3-secure-api-key-management.context" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>3</storyId>
    <title>Secure API Key Management</title>
    <status>drafted</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-3-secure-api-key-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to implement a secure method for managing API keys on the backend</iWant>
    <soThat>they are not exposed to the client-side</soThat>
    <tasks>
- [ ] Review Existing Environment Configuration (AC: 1)
  - [ ] Verify `.env` and `.env.example` files exist from Story 4.1
  - [ ] Review current `.gitignore` includes `.env` files
  - [ ] Confirm environment variables are loaded with `dotenv` package
- [ ] Document Required API Keys (AC: 1)
  - [ ] Add Hugging Face API key variable to `.env.example` (`HUGGINGFACE_API_KEY`)
  - [ ] Add Supabase connection variables to `.env.example` (`SUPABASE_URL`, `SUPABASE_ANON_KEY`)
  - [ ] Add Resend email API key to `.env.example` (`RESEND_API_KEY`)
  - [ ] Add documentation comments describing each key's purpose
- [ ] Implement API Key Access Module (AC: 1)
  - [ ] Create `backend/src/services/config.ts` for centralized config management
  - [ ] Export typed config object with all API keys
  - [ ] Add runtime validation to ensure required keys are present at startup
  - [ ] Throw descriptive errors if required keys are missing
- [ ] Verify Security Best Practices (AC: 1)
  - [ ] Confirm `.env` file is in `.gitignore`
  - [ ] Verify no API keys in codebase (grep check)
  - [ ] Document key rotation process in README or deployment docs
  - [ ] Add startup validation test: server fails to start if keys missing
    </tasks>
  </story>

  <acceptanceCriteria>
1.  **Given** the backend service
    *   **When** it makes calls to external AI or email services
    *   **Then** it uses API keys stored securely on the server (e.g., as environment variables).
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Security Architecture</section>
        <snippet>
**API Key Management**: All sensitive API keys (for Hugging Face models, Supabase, and Resend) will be stored exclusively on the backend service (e.g., as environment variables) and will **never** be exposed to the client-side.
        </snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 4.3: Secure API Key Management</section>
        <snippet>
As a developer, I want to implement a secure method for managing API keys on the backend, so that they are not exposed to the client-side. Use environment variables (.env file) to store API keys. Never commit API keys to version control.
        </snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/src/index.ts</path>
        <kind>server entry point</kind>
        <symbol>dotenv.config()</symbol>
        <lines>5-6</lines>
        <reason>Existing environment variable loading mechanism from Story 4.1</reason>
      </artifact>
      <artifact>
        <path>backend/.env.example</path>
        <kind>environment template</kind>
        <symbol>N/A</symbol>
        <lines>1-9</lines>
        <reason>Current template with placeholder comments for API keys. Needs expansion with actual key names.</reason>
      </artifact>
      <artifact>
        <path>backend/.gitignore</path>
        <kind>git ignore file</kind>
        <symbol>N/A</symbol>
        <lines>2-3</lines>
        <reason>Already excludes .env and .env.local from version control (Story 4.1)</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="dotenv" version="^17.2.3" note="Already installed in Story 4.1" />
        <package name="typescript" version="^5.9.3" note="For type-safe config module" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>All API keys must be environment variables, never hardcoded</constraint>
    <constraint>.env file must be in .gitignore (already done in Story 4.1)</constraint>
    <constraint>Create typed config module in backend/src/services/config.ts</constraint>
    <constraint>Server must fail at startup if required keys are missing</constraint>
    <constraint>Required keys: HUGGINGFACE_API_KEY, SUPABASE_URL, SUPABASE_ANON_KEY, RESEND_API_KEY</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Config Module</name>
      <kind>TypeScript module export</kind>
      <signature>export const config: { huggingFaceApiKey: string; supabase: { url: string; anonKey: string }; resendApiKey: string }</signature>
      <path>backend/src/services/config.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Runtime validation testing. Server should fail to start if required environment variables are missing. Verify .env file is gitignored. Grep codebase to ensure no hardcoded API keys.
    </standards>
    <locations>
      <location>Manual verification: Remove required env vars and attempt server start</location>
      <location>Grep check: Search codebase for potential hardcoded keys</location>
    </locations>
    <ideas>
      <idea>Test server startup fails with missing HUGGINGFACE_API_KEY</idea>
      <idea>Test server startup fails with missing SUPABASE_URL</idea>
      <idea>Test server startup fails with missing RESEND_API_KEY</idea>
      <idea>Verify .env file is not tracked by git</idea>
      <idea>Grep for "sk-" or "API" patterns in source code (no hardcoded keys)</idea>
    </ideas>
  </tests>
</story-context>
